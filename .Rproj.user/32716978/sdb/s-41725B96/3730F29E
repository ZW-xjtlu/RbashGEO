{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Download and process new data\"\nauthor: \"Zhen\"\ndate: \"2017/9/22\"\noutput: html_document\n---\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\n```\n\n## Attend to download new data\n\n```{r}\n\nWgetQC <- function (GEO_accession = \"SRR1234567\", Paired = F) \n{\n    URL = paste(\"ftp://ftp-trace.ncbi.nih.gov/sra/sra-instant/reads/ByRun/sra/SRR\", \n        substr(GEO_accession, 1, 6), GEO_accession, paste0(GEO_accession, \n            \".sra\"), sep = \"/\")\n    Wget_command = paste(\"wget -c -t 0\", URL)\n    fastq_dump_command = paste0(\"fastq-dump \", ifelse(Paired, \n        \"--split-3 \", \"\"), GEO_accession, \".sra\")\n    if (Paired) {\n        fastqc_command = paste0(\"fastqc \", GEO_accession, \"_1.fastq\", \n            \";\", \"fastqc \", GEO_accession, \"_2.fastq\")\n    }\n    else {\n        fastqc_command = paste0(\"fastqc \", GEO_accession, \".fastq\")\n    }\n    paste(Wget_command, fastq_dump_command, fastqc_command, sep = \";\")\n}\n\nnohup_R <- function(command,output = \"X\") {\n  write(command,paste0(output,\".sh\"))\n  system(paste0(\"chmod +x ./\", paste0(output,\".sh\")))\n  system(paste0(\"nohup ./\",paste0(output,\".sh\"), ifelse(is.null(output),\"\",paste0(\" > \",output,\".out\")),\" &\"))\n}  \nsapply(paste0(\"SRR\",3066062:3066069),function(x) nohup_R(WgetQC(x),x))\n\n```\n\n```{bash}\nscp zhen@10.7.6.53:/home/zhen/TREW_new_data/*.html /Users/weizhen\n```\n\nThese data are already very \"clean\", they do not have any adaptors / low quality ends.\n\n#Hisat2\n\n```{bash}\ncd /home/zhen/TREW_new_data/\n\n##cat >>hisat2.sh <<EOF__\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR3066062.fastq -S SRR3066062.sam &\n\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR3066063.fastq -S SRR3066063.sam &\n\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR3066064.fastq -S SRR3066064.sam &\n\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR3066065.fastq -S SRR3066065.sam &\n\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR3066066.fastq -S SRR3066066.sam &\n\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR3066067.fastq -S SRR3066067.sam &\n\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR3066068.fastq -S SRR3066068.sam &\n\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR3066069.fastq -S SRR3066069.sam &\nEOF__\nchmod u+x hisat2.sh\n\nnohup ./hisat2.sh > hisat2.out\n```\n\n```{r}\nlibrary(TxDb.Hsapiens.UCSC.hg19.knownGene)\ntxdb = TxDb.Hsapiens.UCSC.hg19.knownGene\nall_hg19_tx <- transcripts(txdb)\nall_hg19_ex <- exons(txdb)\n\nsum(as.numeric(width(reduce( all_hg19_tx ))))/4\n\nsum(as.numeric(width(reduce( all_hg19_ex ))))/4\n\nsum(as.numeric(width(reduce( all_hg19_tx ))))/50\n\nsum(as.numeric(width(reduce( all_hg19_ex ))))/50\n```\n\nThink about the new bins based methods\n\n- All As on transcripts...(sbrl but slow)\n- roughly 50bp bins on transcripts... (not sb rl)\n\n348410075 As estimated to have on exons and introns.\n\n22307356 As estimated to have on introns.\n\n1784588 if we use 50bp bins on exons (realistic).\n\n500000 using RMBase. (good, and still have intronic sequence) - choose.\n\nPotential new papers: \n\n1. Fat mass and obesity-associated (FTO) protein regulates adult neurogenesis.\n\n- invalid, because they don't do FTO- IP....\n\n2. m6A RNA Methylation Regulates the Self-Renewal and Tumorigenesis of Glioblastoma Stem Cells.\n\n- https://www.ncbi.nlm.nih.gov/Traces/study/?acc=SRP099397\n- have m3 and 2*m4 target with 1 replicate.\n\n3. The N6-methyladenosine (m6A)-forming enzyme METTL3 controls myeloid differentiation of normal hematopoietic and leukemia cells.\n\n- invalid, this is a m3 knock down RNA-Seq data with no m6A-Seq design.\n\nGenerally, only some labs are interested in the purterbation of m6A-Seq data after kd of protein effectors.\n\n4. Mettl3-mediated m6A regulates spermatogonial differentiation and meiosis initiation.\n\n- invalid, it contains only miCLip and RNA-Seq dataset, but this study is generally interested.\n\n- The miCLip data is a powerful SBRL new technique, that can potentially substitute m6A-Seq.\n\nsee: \"single-nucleotide-resolution mapping of m6A and m6Am throughout the transcriptome\"\n\nGSM2652081_m6A_P12-Ctrl_rep1.bed.gz\nGSM2652081_m6A_P12-Ctrl_rep2.bed.gz\n\nThese 2 bed files can potentially enrich the mm10 sn database of m6A and m6Am.\n\n5. The requirement of Mettl3-promoted MyoD mRNA maintenance in proliferative myoblasts for skeletal muscle differentiation.\n\nThis paper is generally having very limited sample # and being RIP-seq.\n\n##download the low quality data and the new data\n```{r}\n\nWgetQC <- function (GEO_accession = \"SRR1234567\", Paired = F) \n{\n    URL = paste(\"ftp://ftp-trace.ncbi.nih.gov/sra/sra-instant/reads/ByRun/sra/SRR\", \n        substr(GEO_accession, 1, 6), GEO_accession, paste0(GEO_accession, \n            \".sra\"), sep = \"/\")\n    Wget_command = paste(\"wget -c -t 0\", URL)\n    fastq_dump_command = paste0(\"fastq-dump \", ifelse(Paired, \n        \"--split-3 \", \"\"), GEO_accession, \".sra\")\n    if (Paired) {\n        fastqc_command = paste0(\"fastqc \", GEO_accession, \"_1.fastq\", \n            \";\", \"fastqc \", GEO_accession, \"_2.fastq\")\n    }\n    else {\n        fastqc_command = paste0(\"fastqc \", GEO_accession, \".fastq\")\n    }\n    rm_command = paste0(\"rm \", GEO_accession, \".sra\")\n    paste(Wget_command, fastq_dump_command, rm_command, fastqc_command, sep = \";\")\n}\n\nnohup_R <- function(command,output = \"X\") {\n  write(command,paste0(output,\".sh\"))\n  system(paste0(\"chmod +x ./\", paste0(output,\".sh\")))\n  system(paste0(\"nohup ./\",paste0(output,\".sh\"), ifelse(is.null(output),\"\",paste0(\" > \",output,\".out\")),\" &\"))\n}  \n\n\nsapply(paste0(\"SRR\",c(1744126,5248992:5248999)),function(x) nohup_R(WgetQC(x),x))\n```\n\n##Align the new data (the final group).\n\n```{bash}\nscp zhen@10.7.6.53:/home/zhen/TREW_new_data/SRR1744126_fastqc.html /Users/weizhen\nscp zhen@10.7.6.53:/home/zhen/TREW_new_data/SRR5248994_fastqc.html /Users/weizhen\n\n##cat >>hisat2-1.sh <<EOF__\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR1744126.fastq -S SRR1744126.sam & \nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR5248994.fastq -S SRR5248994.sam &\nEOF__\nchmod u+x hisat2-1.sh\n\n#The alignment efficiency for the SRR1744126 is still quite poor.\n\nnohup ./hisat2-1.sh > hisat2-1.out\n\nnohup fastx_trimmer -f 17 -l 37 -i ./SRR1744126.fastq -o ./SRR1744126-trimmed-1.fastq &\nnohup fastx_trimmer -f 14 -l 50 -i ./SRR1744126.fastq -o ./SRR1744126-trimmed-2.fastq &\n\n#cat >>Fix-SRR1744126.sh <<EOF__\nhisat2 -p 8 --tmo -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR1744126-trimmed-1.fastq -S SRR1744126-trimmed-1.sam &\nhisat2 -p 8 --tmo -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR1744126-trimmed-2.fastq -S SRR1744126-trimmed-2.sam &\nEOF__\nchmod u+x Fix-SRR1744126.sh\nnohup ./Fix-SRR1744126.sh > Fix-SRR1744126.out\n\nhisat2 -p 8 --tmo -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR1744126-trimmed-2.fastq -S SRR1744126-trimmed-2.sam\n\n#cat >>hisat2-2.sh <<EOF__\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR5248992.fastq -S SRR5248992.sam &\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR5248993.fastq -S SRR5248993.sam &\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR5248995.fastq -S SRR5248995.sam &\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR5248996.fastq -S SRR5248996.sam &\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR5248997.fastq -S SRR5248997.sam &\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR5248998.fastq -S SRR5248998.sam &\nhisat2 -p 8 --dta -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR5248999.fastq -S SRR5248999.sam &\nEOF__\nchmod u+x hisat2-2.sh\n\nchmod u+x hisat2-2.sh\nnohup ./hisat2-2.sh > hisat2-2.out\n\n```\n\n\nToDo: tomorrow... create a directory called 2T... all use --mto\n\nfinally, report the final alignment efficiencies.\n\nImportantly, run the DM QC successfully to existing datasets.\n\nhisat2 -p 8 --tmo --no-unal -x /home/zhen/hisat2_idx/hg19/genome -U /home/zhen/TREW_new_data/SRR3066069.fastq -S SRR3066069.sam\n\n\n```{r}\nRhisat2 <- function (Fastq_file_name = \"SRR1234567\",\n                     indx_directory = \"/home/zhen/hisat2_idx/hg19/genome\",\n                       Fastq_directory = \".\", \n                         Paired = F, \n                           trim_5 = NULL, \n                             trim_3 = NULL, \n                                  parallel_num = 8,\n                                    Fastq_file_end = \".fastq\",\n                                         output_name = Fastq_file_name,\n                                          tune_Mismatch_MX = NULL,\n                                            tune_Mismatch_MN = NULL) \n{\n    Fastq_directory = gsub(\"/$\",\"\",Fastq_directory)\n    if (Paired) {\n        input_argument = paste0( \" -1 \",Fastq_directory,\"/\",Fastq_file_name,\"_1\",Fastq_file_end,\" -2 \",Fastq_directory,\"/\",Fastq_file_name,\"_2\",Fastq_file_end)\n    }\n    else {\n        input_argument = paste0( \" -U \",Fastq_directory,\"/\",Fastq_file_name,Fastq_file_end)\n    }\n    \n    trim_argument = ifelse(is.null(trim_5),\"\",paste0(\" -5 \",trim_5,\" -3 \",trim_3))\n    \n    mismatch_argument = ifelse(is.null(tune_Mismatch_MX),\"\",paste0(\"--mp \",tune_Mismatch_MX,\",\",tune_Mismatch_MN))\n    \n    output_argument = paste0(\" -S \",output_name,\".sam\")\n    \n  paste0(\"hisat2 -p \",parallel_num, trim_argument, mismatch_argument,\" --no-unal -x \",indx_directory,input_argument,output_argument)\n}\n\nRnohup <- function(command,output = \"X\") {\n  write(command,paste0(output,\".sh\"))\n  system(paste0(\"chmod +x ./\", paste0(output,\".sh\")))\n  system(paste0(\"nohup ./\",paste0(output,\".sh\"), ifelse(is.null(output),\"\",paste0(\" > \",output,\".out\")),\" &\"))\n}  \n\n#A multi-argument example\narg_df <- data.frame(\n                     Fastq_file_name = rep(\"SRR1744126\",3), \n                     trim_5 = c(16,16,0),\n                     trim_3 = c(12,0,12),\n                     output_name = paste0(\"SRR1744126_\",1:3)\n                     )\n\nlibrary(dplyr)\n\nfor(i in 1:nrow(arg_df)) {\n      x = arg_df[i,]\n        Rhisat2(Fastq_file_name = x$Fastq_file_name,\n                trim_5 = x$trim_5,\n                trim_3 = x$trim_3,\n                output_name = x$output_name,\n                Fastq_directory = \"/home/zhen/TREW_new_data\") %>% Rnohup(.,paste0(x$output_name,\"_hisat2\") )\n}\n\n#An automatic example... process every fastq in current working directory. \nFq_filenames <- gsub(\".fastq\",\"\",grep(\".fastq$\",list.files(),value = T) )\n\nsapply(\n    Fq_filenames,\n        function(x){\n            Rhisat2(Fastq_file_name = x,\n                    Paired = F,\n                    Fastq_directory = getwd()) %>% Rnohup(.,paste0(x,\"_hisat2\") )\n}\n)\n\n#A function to quickly check the alignment efficiencies in R\nCheck_hisat2_result <- function(result_tail=\"_hisat2.out\"){\nHisat2_Output_filenames <- grep(paste0(result_tail,\"$\"),list.files(),value = T)\nlst_result <- lapply(Hisat2_Output_filenames,readLines)\nSRR_names = gsub(paste0(result_tail,\"$\"),\"\" ,Hisat2_Output_filenames )\nnames(lst_result) = SRR_names\nlst_result\n}\n\nNot_worked <- SRR_names[sapply(lst_result,function(x) length(x) <= 1)]\n\nsapply(\n    Not_worked[-1],\n        function(x){\n            Rhisat2(Fastq_file_name = x,\n                    Paired = F,\n                    Fastq_directory = getwd()) %>% Rnohup(.,paste0(x,\"_hisat2\") )\n}\n)\n```\n$SRR1744126_2\n[1] \"41006665 reads; of these:\"                    \n[2] \"  41006665 (100.00%) were unpaired; of these:\"\n[3] \"    26677912 (65.06%) aligned 0 times\"        \n[4] \"    4181175 (10.20%) aligned exactly 1 time\"  \n[5] \"    10147578 (24.75%) aligned >1 times\"       \n[6] \"34.94% overall alignment rate\"                \n\n$SRR1744126_3\n[1] \"41006665 reads; of these:\"                    \n[2] \"  41006665 (100.00%) were unpaired; of these:\"\n[3] \"    27402055 (66.82%) aligned 0 times\"        \n[4] \"    2722848 (6.64%) aligned exactly 1 time\"   \n[5] \"    10881762 (26.54%) aligned >1 times\"       \n[6] \"33.18% overall alignment rate\"                \n\n$SRR1744126\n[1] \"41006665 reads; of these:\"                    \n[2] \"  41006665 (100.00%) were unpaired; of these:\"\n[3] \"    28695407 (69.98%) aligned 0 times\"        \n[4] \"    2553083 (6.23%) aligned exactly 1 time\"   \n[5] \"    9758175 (23.80%) aligned >1 times\"        \n[6] \"30.02% overall alignment rate\"                \n\n$SRR3066062\n[1] \"21561344 reads; of these:\"                    \n[2] \"  21561344 (100.00%) were unpaired; of these:\"\n[3] \"    844836 (3.92%) aligned 0 times\"           \n[4] \"    14360603 (66.60%) aligned exactly 1 time\" \n[5] \"    6355905 (29.48%) aligned >1 times\"        \n[6] \"96.08% overall alignment rate\"                \n\n$SRR3066063\n[1] \"20466641 reads; of these:\"                    \n[2] \"  20466641 (100.00%) were unpaired; of these:\"\n[3] \"    800184 (3.91%) aligned 0 times\"           \n[4] \"    13788135 (67.37%) aligned exactly 1 time\" \n[5] \"    5878322 (28.72%) aligned >1 times\"        \n[6] \"96.09% overall alignment rate\"                \n\n$SRR3066064\n[1] \"17714000 reads; of these:\"                    \n[2] \"  17714000 (100.00%) were unpaired; of these:\"\n[3] \"    602432 (3.40%) aligned 0 times\"           \n[4] \"    11487499 (64.85%) aligned exactly 1 time\" \n[5] \"    5624069 (31.75%) aligned >1 times\"        \n[6] \"96.60% overall alignment rate\"                \n\n$SRR3066065\n[1] \"24903917 reads; of these:\"                    \n[2] \"  24903917 (100.00%) were unpaired; of these:\"\n[3] \"    916149 (3.68%) aligned 0 times\"           \n[4] \"    16830061 (67.58%) aligned exactly 1 time\" \n[5] \"    7157707 (28.74%) aligned >1 times\"        \n[6] \"96.32% overall alignment rate\"                \n\n$SRR3066066\n[1] \"45887508 reads; of these:\"                    \n[2] \"  45887508 (100.00%) were unpaired; of these:\"\n[3] \"    2267939 (4.94%) aligned 0 times\"          \n[4] \"    29159788 (63.55%) aligned exactly 1 time\" \n[5] \"    14459781 (31.51%) aligned >1 times\"       \n[6] \"95.06% overall alignment rate\"                \n\n$SRR3066067\n[1] \"30829176 reads; of these:\"                    \n[2] \"  30829176 (100.00%) were unpaired; of these:\"\n[3] \"    1367100 (4.43%) aligned 0 times\"          \n[4] \"    18983072 (61.58%) aligned exactly 1 time\" \n[5] \"    10479004 (33.99%) aligned >1 times\"       \n[6] \"95.57% overall alignment rate\"                \n\n$SRR3066068\n[1] \"29936502 reads; of these:\"                    \n[2] \"  29936502 (100.00%) were unpaired; of these:\"\n[3] \"    1140716 (3.81%) aligned 0 times\"          \n[4] \"    19336610 (64.59%) aligned exactly 1 time\" \n[5] \"    9459176 (31.60%) aligned >1 times\"        \n[6] \"96.19% overall alignment rate\"                \n\n$SRR3066069\n[1] \"34024847 reads; of these:\"                    \n[2] \"  34024847 (100.00%) were unpaired; of these:\"\n[3] \"    1364958 (4.01%) aligned 0 times\"          \n[4] \"    21882896 (64.31%) aligned exactly 1 time\" \n[5] \"    10776993 (31.67%) aligned >1 times\"       \n[6] \"95.99% overall alignment rate\"                \n\n$SRR5248992\n[1] \"20221057 reads; of these:\"                    \n[2] \"  20221057 (100.00%) were unpaired; of these:\"\n[3] \"    3260067 (16.12%) aligned 0 times\"         \n[4] \"    11364242 (56.20%) aligned exactly 1 time\" \n[5] \"    5596748 (27.68%) aligned >1 times\"        \n[6] \"83.88% overall alignment rate\"                \n\n$SRR5248993\n[1] \"17844214 reads; of these:\"                    \n[2] \"  17844214 (100.00%) were unpaired; of these:\"\n[3] \"    3134834 (17.57%) aligned 0 times\"         \n[4] \"    9870956 (55.32%) aligned exactly 1 time\"  \n[5] \"    4838424 (27.11%) aligned >1 times\"        \n[6] \"82.43% overall alignment rate\"                \n\n$SRR5248994\n[1] \"20692299 reads; of these:\"                    \n[2] \"  20692299 (100.00%) were unpaired; of these:\"\n[3] \"    2672492 (12.92%) aligned 0 times\"         \n[4] \"    12068176 (58.32%) aligned exactly 1 time\" \n[5] \"    5951631 (28.76%) aligned >1 times\"        \n[6] \"87.08% overall alignment rate\"                \n\n$SRR5248995\n[1] \"18476868 reads; of these:\"                    \n[2] \"  18476868 (100.00%) were unpaired; of these:\"\n[3] \"    3517189 (19.04%) aligned 0 times\"         \n[4] \"    9789108 (52.98%) aligned exactly 1 time\"  \n[5] \"    5170571 (27.98%) aligned >1 times\"        \n[6] \"80.96% overall alignment rate\"                \n\n$SRR5248996\n[1] \"16721562 reads; of these:\"                    \n[2] \"  16721562 (100.00%) were unpaired; of these:\"\n[3] \"    11876864 (71.03%) aligned 0 times\"        \n[4] \"    3827585 (22.89%) aligned exactly 1 time\"  \n[5] \"    1017113 (6.08%) aligned >1 times\"         \n[6] \"28.97% overall alignment rate\"                \n\n$SRR5248997\n[1] \"21266062 reads; of these:\"                    \n[2] \"  21266062 (100.00%) were unpaired; of these:\"\n[3] \"    15848857 (74.53%) aligned 0 times\"        \n[4] \"    4258881 (20.03%) aligned exactly 1 time\"  \n[5] \"    1158324 (5.45%) aligned >1 times\"         \n[6] \"25.47% overall alignment rate\"                \n\n$SRR5248998\n[1] \"18911183 reads; of these:\"                    \n[2] \"  18911183 (100.00%) were unpaired; of these:\"\n[3] \"    11166079 (59.04%) aligned 0 times\"        \n[4] \"    6109024 (32.30%) aligned exactly 1 time\"  \n[5] \"    1636080 (8.65%) aligned >1 times\"         \n[6] \"40.96% overall alignment rate\"                \n\n$SRR5248999\n[1] \"18363202 reads; of these:\"                    \n[2] \"  18363202 (100.00%) were unpaired; of these:\"\n[3] \"    11642976 (63.40%) aligned 0 times\"        \n[4] \"    5294424 (28.83%) aligned exactly 1 time\"  \n[5] \"    1425802 (7.76%) aligned >1 times\"         \n[6] \"36.60% overall alignment rate\"    \n\n\n```{bash}\nkill 16330                                                                                                                           \nkill 16216                                                                                                                          \nkill 16279      \nkill 16307                                                                         \nkill 16286                                                                        \nkill 16291                                                                        \nkill 16293                                                                        \nkill 16277\n```\n\n",
    "created" : 1506404853161.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3029399554",
    "id" : "3730F29E",
    "lastKnownWriteTime" : 1506407844,
    "last_content_update" : 1506407844719,
    "path" : "~/Desktop/Research/TREW conservation/9. Introduce new data.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}